name: Deploy Admin Portal Web (Docker CI/CD)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: âœï¸ Generate .env file for production build
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env
          echo "VITE_APPLICATION_ID=${{ secrets.VITE_APPLICATION_ID }}" >> .env
          echo "DEBUG: VITE_APPLICATION_ID=${{ secrets.VITE_APPLICATION_ID }}"
          cat .env

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ Debug dist folder
        run: |
          pwd
          ls -lart
          ls -lart dist || echo "no dist yet"

      - name: ğŸ List dist content
        run: ls -l dist && cat dist/index.html | head -n 20

      - name: ğŸ³ Build Docker image
        run: docker build -f Dockerfile.production -t admin_portal_web .

      - name: ğŸ“¦ Save Docker image as .tar
        run: docker save -o admin_portal_web.tar admin_portal_web

      - name: ğŸš€ Upload image to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "admin_portal_web.tar"
          target: "/root/"

      - name: ğŸ³ Load and run container on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "ğŸ›‘ Stopping previous container (if exists)..."
            docker stop admin_portal_web || true
            docker rm admin_portal_web || true

            echo "ğŸ“¦ Loading new Docker image..."
            docker load -i /root/admin_portal_web.tar

            echo "ğŸ”Œ Ensure Docker network 'app_network' exists..."
            docker network create app_network || true

            echo "ğŸš€ Running new container (no public port exposed)..."
            docker run -d \
              --name admin_portal_web \
              --network app_network \
              admin_portal_web

            echo "âœ… Deployment complete!"
